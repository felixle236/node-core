import { Inject, Service } from 'typedi';
import { mapModel, mapModels } from '../../libs/common';
import { {PascalName} } from '../models/{PascalName}';
import { {PascalName}CreateRequest } from '../dtos/{camelName}/requests/{PascalName}CreateRequest';
import { {PascalName}FilterRequest } from '../dtos/{camelName}/requests/{PascalName}FilterRequest';
import { {PascalName}Response } from '../dtos/{camelName}/responses/{PascalName}Response';
import { {PascalName}UpdateRequest } from '../dtos/{camelName}/requests/{PascalName}UpdateRequest';
import { I{PascalName}Business } from '../gateways/businesses/I{PascalName}Business';
import { I{PascalName}Repository } from '../gateways/gateways/data/I{PascalName}Repository';
import { ResultListResponse } from '../dtos/common/ResultListResponse';
import { SystemError } from '../dtos/common/Exception';

@Service('{camelName}.business')
export class {PascalName}Business implements I{PascalName}Business {
    @Inject('{camelName}.repository')
    private readonly _{camelName}Repository: I{PascalName}Repository;

    async find(filter: {PascalName}FilterRequest): Promise<ResultListResponse<{PascalName}Response>> {
        const [list, count] = await this._{camelName}Repository.find(filter);
        return filter.toResultList(mapModels({PascalName}Response, list), count);
    }

    async getById(id: number): Promise<{PascalName}Response | undefined> {
        const {camelName} = await this._{camelName}Repository.getById(id);
        return mapModel({PascalName}Response, {camelName});
    }

    async create(data: {PascalName}CreateRequest): Promise<{PascalName}Response | undefined> {
        const {camelName} = new {PascalName}();
        {camelName}.name = data.name;

        if (await this._{camelName}Repository.checkNameExist({camelName}.name))
            throw new SystemError(MessageError.PARAM_EXISTED, 'name');

        const createData = {camelName}.toCreateData();
        const id = await this._{camelName}Repository.create(createData);
        if (!id)
            throw new SystemError(MessageError.DATA_CANNOT_SAVE);

        const newData = await this._{camelName}Repository.getById(id);
        return mapModel({PascalName}Response, newData);
    }

    async update(id: number, data: {PascalName}UpdateRequest): Promise<{PascalName}Response | undefined > {
        const {camelName} = await this._{camelName}Repository.getById(id);
        if (!{camelName})
            throw new SystemError(MessageError.PARAM_NOT_EXISTS, '{camelName}');

        {camelName}.name = data.name;

        if (await this._{camelName}Repository.checkNameExist({camelName}.name, id))
            throw new SystemError(MessageError.PARAM_EXISTED, 'name');

        const updateData = {camelName}.toUpdateData();
        const hasSucceed = await this._{camelName}Repository.update(id, updateData);
        if (!hasSucceed)
            throw new SystemError(MessageError.DATA_CANNOT_SAVE);

        const newData = await this._{camelName}Repository.getById(id);
        return mapModel({PascalName}Response, newData);
    }

    async delete(id: number): Promise<boolean> {
        const {camelName} = await this._{camelName}Repository.getById(id);
        if (!{camelName})
            throw new SystemError(MessageError.PARAM_NOT_EXISTS, '{camelName}');

        return await this._{camelName}Repository.delete(id);
    }
}
